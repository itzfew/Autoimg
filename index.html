<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Exam Portal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f7f7f7; }
    header { background: #007bff; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    nav a { color: white; margin: 0 10px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .profile-pic {
        background: white; color: #007bff; border-radius: 50%; width: 40px; height: 40px;
        display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 18px;
    }
    .container { padding: 20px; }
    .form-box { background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: 40px auto; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #progressBar { display: none; margin: 20px auto; width: 80%; background: #ccc; border-radius: 10px; }
    #progressBar div { height: 20px; width: 0%; background: green; border-radius: 10px; }
</style>
</head>
<body>

<header>
    <div>ðŸ“š Exam Portal</div>
    <nav id="navLinks"></nav>
    <div id="profilePic" class="profile-pic" style="display:none;"></div>
</header>

<div id="progressBar"><div></div></div>

<div class="container" id="mainContent">
    <!-- Login / Signup -->
    <div class="form-box" id="authForms">
        <h2>Login</h2>
        <input type="text" id="loginUsername" placeholder="Username" required>
        <input type="text" id="loginRoll" placeholder="Roll Number" required>
        <button onclick="login()">Login</button>
        <hr>
        <h2>Sign Up</h2>
        <input type="text" id="signupName" placeholder="Full Name" required>
        <input type="text" id="signupUsername" placeholder="Username (no spaces)" required>
        <input type="date" id="signupDob" required>
        <button onclick="signup()">Sign Up</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display:none;">
        <h2>Welcome, <span id="userName"></span>!</h2>
        <p id="examStatus"></p>
    </div>
</div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbx-HPTKFkmhd2gJXgd9JFTjcgamCumgLbOseFp0ZLR7EFC-65v7oSIybsEZYnYvnFXHww/exec";
const { jsPDF } = window.jspdf;

// Progress bar control
function showProgress() {
    const bar = document.querySelector("#progressBar");
    const fill = bar.querySelector("div");
    bar.style.display = "block";
    fill.style.width = "0%";
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        fill.style.width = progress + "%";
        if (progress >= 100) clearInterval(interval);
    }, 50);
}
function hideProgress() { document.querySelector("#progressBar").style.display = "none"; }

// Login
function login() {
    let username = document.getElementById("loginUsername").value.trim();
    let roll = document.getElementById("loginRoll").value.trim();
    if (!username || !roll) return alert("Fill all fields");

    fetch(`${apiURL}?action=login&username=${username}&roll=${roll}`)
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            localStorage.setItem("user", JSON.stringify(data.user));
            loadDashboard();
        } else {
            alert("Invalid credentials");
        }
    });
}

// Signup
function signup() {
    let name = document.getElementById("signupName").value.trim();
    let username = document.getElementById("signupUsername").value.trim();
    let dob = document.getElementById("signupDob").value;
    if (!name || !username || !dob) return alert("Fill all fields");

    let roll = dob.split("-")[0] + new Date().getDate();
    fetch(apiURL, {
        method: "POST",
        body: JSON.stringify({ action: "signup", name, username, dob, roll })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            localStorage.setItem("user", JSON.stringify({ name, username, roll, attempted: false }));
            loadDashboard();
        } else {
            alert("Signup failed");
        }
    });
}

// Load dashboard
function loadDashboard() {
    let user = JSON.parse(localStorage.getItem("user"));
    if (!user) return;
    document.getElementById("authForms").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("userName").innerText = user.name;
    document.getElementById("profilePic").style.display = "flex";
    document.getElementById("profilePic").innerText = user.name.charAt(0).toUpperCase();

    fetch(`${apiURL}?action=checkAttempt&username=${user.username}&roll=${user.roll}`)
    .then(res => res.json())
    .then(data => {
        let attempted = data.attempted;
        user.attempted = attempted;
        localStorage.setItem("user", JSON.stringify(user));
        let navHTML = `<a href="#" onclick="downloadAllResults()">Results</a>`;
        if (!attempted) {
            navHTML += `<a href="exam.html">Attempt Test</a>`;
        } else {
            navHTML += `<a href="#" onclick="downloadMyResults()">My Results</a>`;
            navHTML += `<a href="#" onclick="downloadCertificate()">Certificate</a>`;
        }
        navHTML += `<a href="#" onclick="signout()">Signout</a>`;
        document.getElementById("navLinks").innerHTML = navHTML;
        document.getElementById("examStatus").innerText = attempted ? "You have already attempted the exam." : "You can attempt the exam now.";
    });
}

// PDF functions
function downloadAllResults() {
    showProgress();
    fetch(`${apiURL}?action=getResults`)
    .then(res => res.json())
    .then(data => {
        hideProgress();
        const doc = new jsPDF();
        doc.text("All Results", 10, 10);
        let y = 20;
        data.results.forEach(r => {
            doc.text(`${r.name} - ${r.roll} - ${r.marks}`, 10, y);
            y += 10;
        });
        doc.save("all_results.pdf");
    });
}
function downloadMyResults() {
    let user = JSON.parse(localStorage.getItem("user"));
    showProgress();
    fetch(`${apiURL}?action=getMyResult&username=${user.username}&roll=${user.roll}`)
    .then(res => res.json())
    .then(data => {
        hideProgress();
        const doc = new jsPDF();
        doc.text("My Detailed Results", 10, 10);
        let y = 20;
        data.details.forEach(d => {
            doc.text(`${d.question} - Your: ${d.yourAnswer} - Correct: ${d.correctAnswer}`, 10, y);
            y += 10;
        });
        doc.save("my_results.pdf");
    });
}
function downloadCertificate() {
    let user = JSON.parse(localStorage.getItem("user"));
    showProgress();
    fetch(`${apiURL}?action=getCertificate&username=${user.username}&roll=${user.roll}`)
    .then(res => res.json())
    .then(data => {
        hideProgress();
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.text("Certificate of Achievement", 40, 40);
        doc.setFontSize(14);
        doc.text(`This is to certify that ${user.name} has successfully completed the exam.`, 20, 60);
        doc.text(`Score: ${data.score}`, 20, 80);
        doc.save("certificate.pdf");
    });
}

function signout() {
    localStorage.removeItem("user");
    location.reload();
}

// On load
if (localStorage.getItem("user")) {
    loadDashboard();
}
</script>
</body>
</html>
