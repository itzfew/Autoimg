<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Online Exam System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
.container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
input, button { padding: 10px; margin: 5px 0; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
button { background: #28a745; color: #fff; cursor: pointer; border: none; }
button:hover { background: #218838; }
.hidden { display: none; }
h2, h3 { text-align: center; }
p { text-align: center; }
label { display: block; margin: 5px 0; }
</style>
</head>
<body>

<div class="container">
    <h2>Welcome to the Exam System</h2>

    <!-- Registration -->
    <div id="registerBox">
        <h3>Create Account</h3>
        <input type="text" id="name" placeholder="Full Name">
        <input type="text" id="username" placeholder="Username (no spaces)">
        <input type="date" id="dob">
        <button onclick="registerUser()">Create Account</button>
        <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
    </div>

    <!-- Login -->
    <div id="loginBox" class="hidden">
        <h3>Login</h3>
        <input type="text" id="loginUsername" placeholder="Username">
        <input type="text" id="loginRoll" placeholder="Roll Number">
        <button onclick="loginUser()">Login</button>
        <p>Don't have a roll number? <a href="#" onclick="showRegister()">Create New</a></p>
    </div>

    <!-- Exam -->
    <div id="examBox" class="hidden">
        <h3>Exam: Seerat-e-Mustafa</h3>
        <form id="examForm"></form>
        <button onclick="submitExam()">Submit Exam</button>
    </div>

    <!-- Results -->
    <div id="resultBox" class="hidden">
        <h3>Your Result</h3>
        <p id="resultText"></p>
        <button onclick="downloadCertificate()">Download Certificate</button>
    </div>
</div>

<script>
const APP_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL"; // Replace with your deployed Google Apps Script Web App URL
let currentUser = null;
let quizData = null;
const QUIZ_ID = 'hdjsk299e93uee'; // Hardcoded quiz ID for Seerat-e-Mustafa
const QUIZ_JSON_URL = `quizes/${QUIZ_ID}.json`; // Path to your quiz JSON file (assume hosted)

// Show Registration
function showRegister() {
    document.getElementById("registerBox").classList.remove("hidden");
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("examBox").classList.add("hidden");
    document.getElementById("resultBox").classList.add("hidden");
}

// Show Login
function showLogin() {
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("registerBox").classList.add("hidden");
    document.getElementById("examBox").classList.add("hidden");
    document.getElementById("resultBox").classList.add("hidden");
}

// Register User
function registerUser() {
    let name = document.getElementById("name").value.trim();
    let username = document.getElementById("username").value.trim();
    let dob = document.getElementById("dob").value;
    if (!name || !username || !dob) return alert("All fields are required");
    if (/\s/.test(username)) return alert("Username must not contain spaces");

    fetch(APP_URL, {
        method: "POST",
        body: JSON.stringify({ action: "saveUser", name, username, dob }), // No rollNumber, let server generate
    }).then(r => r.json()).then(res => {
        if (res.status === "exists") {
            alert("Username already exists!");
        } else if (res.status === "success") {
            let rollNumber = res.user.rollNumber;
            alert(`Account created! Your Roll Number: ${rollNumber}`);
            generateAdmitCard(name, username, rollNumber, dob);
            showLogin(); // Redirect to login after registration
        } else {
            alert("Error: " + (res.message || "Unknown error"));
        }
    }).catch(err => alert("Network error: " + err));
}

// Login User
function loginUser() {
    let username = document.getElementById("loginUsername").value.trim();
    let rollNumber = document.getElementById("loginRoll").value.trim();
    if (!username || !rollNumber) return alert("Username and Roll Number are required");

    fetch(APP_URL, {
        method: "POST",
        body: JSON.stringify({ action: "login", username, rollNumber })
    }).then(r => r.json()).then(res => {
        if (res.status === "success") {
            currentUser = res.user;
            checkAttempt();
        } else {
            alert("Invalid credentials");
        }
    }).catch(err => alert("Network error: " + err));
}

// Check if already attempted
function checkAttempt() {
    fetch(APP_URL, {
        method: "POST",
        body: JSON.stringify({ action: "checkAttempt", rollNumber: currentUser.rollNumber, quizId: QUIZ_ID })
    }).then(r => r.json()).then(res => {
        if (res.status === "success") {
            if (res.attempted) {
                showResults(res.result);
            } else {
                loadExam();
            }
        } else {
            alert("Error checking attempt: " + (res.message || "Unknown error"));
        }
    }).catch(err => alert("Network error: " + err));
}

// Load Exam
function loadExam() {
    fetch(QUIZ_JSON_URL)
    .then(r => r.json())
    .then(data => {
        quizData = data;
        let form = document.getElementById("examForm");
        form.innerHTML = "";
        quizData.questions.forEach((q, i) => {
            form.innerHTML += `<p>${i + 1}. ${q.question}</p>`;
            q.options.forEach(opt => {
                form.innerHTML += `<label><input type="radio" name="q${i}" value="${opt}"> ${opt}</label><br>`;
            });
            form.innerHTML += `<br>`;
        });
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("examBox").classList.remove("hidden");
    }).catch(err => alert("Error loading quiz: " + err));
}

// Submit Exam
function submitExam() {
    if (!quizData) return alert("Quiz not loaded");
    let answers = [];
    let correct = 0;
    quizData.questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        let ans = chosen ? chosen.value : null;
        let isCorrect = ans === q.answer;
        answers.push({ question: q.question, yourAnswer: ans, correctAnswer: q.answer, isCorrect });
        if (isCorrect) correct++;
    });
    let total = quizData.questions.length;
    let percentage = (correct / total) * 100;
    fetch(APP_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "saveResults",
            quizId: QUIZ_ID,
            rollNumber: currentUser.rollNumber,
            name: currentUser.name,
            username: currentUser.username,
            marks: correct,
            total,
            percentage,
            details: answers
        })
    }).then(r => r.json()).then(res => {
        if (res.status === "success") {
            showResults({ marks: correct, total, percentage });
        } else if (res.status === "blocked") {
            alert("You have already attempted this exam.");
            checkAttempt(); // Refresh to show results
        } else {
            alert("Error saving results: " + (res.message || "Unknown error"));
        }
    }).catch(err => alert("Network error: " + err));
}

// Show Results
function showResults(result) {
    document.getElementById("examBox").classList.add("hidden");
    document.getElementById("resultText").innerText = `You scored ${result.marks}/${result.total} (${result.percentage.toFixed(2)}%)`;
    document.getElementById("resultBox").classList.remove("hidden");
}

// Generate Admit Card PDF (Premium Design)
function generateAdmitCard(name, username, rollNumber, dob) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Background and Border
    doc.setFillColor(240, 240, 240);
    doc.rect(0, 0, 210, 297, 'F'); // A4 size background
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(1);
    doc.rect(10, 10, 190, 277); // Outer border
    
    // Header
    doc.setFontSize(24);
    doc.setFont("helvetica", "bold");
    doc.text("Admit Card", 105, 30, { align: "center" });
    
    // Logo or Watermark (simulated)
    doc.setFontSize(40);
    doc.setTextColor(200, 200, 200);
    doc.text("EXAM SYSTEM", 105, 150, { align: "center", angle: 45 });
    doc.setTextColor(0, 0, 0);
    
    // Details
    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    doc.text(`Name: ${name}`, 20, 60);
    doc.text(`Username: ${username}`, 20, 75);
    doc.text(`Roll Number: ${rollNumber}`, 20, 90);
    doc.text(`Date of Birth: ${dob}`, 20, 105);
    doc.text(`Exam: Seerat-e-Mustafa`, 20, 120);
    
    // Footer
    doc.setFontSize(10);
    doc.text("This admit card is auto-generated. Keep it safe.", 105, 270, { align: "center" });
    
    doc.save("AdmitCard.pdf");
}

// Generate Certificate PDF (Premium Design)
function downloadCertificate() {
    if (!currentUser) return alert("User not loaded");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Background and Border
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, 210, 297, 'F');
    doc.setDrawColor(150, 150, 150);
    doc.setLineWidth(2);
    doc.rect(10, 10, 190, 277); // Outer border
    doc.setLineWidth(0.5);
    doc.rect(15, 15, 180, 267); // Inner border
    
    // Header
    doc.setFontSize(28);
    doc.setFont("times", "bold");
    doc.text("Certificate of Achievement", 105, 40, { align: "center" });
    
    // Subheader
    doc.setFontSize(16);
    doc.setFont("times", "italic");
    doc.text("This is to certify that", 105, 70, { align: "center" });
    
    // Name
    doc.setFontSize(22);
    doc.setFont("times", "bold");
    doc.text(currentUser.name, 105, 90, { align: "center" });
    
    // Body
    doc.setFontSize(14);
    doc.setFont("times", "normal");
    doc.text("has successfully completed the exam on Seerat-e-Mustafa", 105, 110, { align: "center" });
    doc.text(`with a score of ${document.getElementById("resultText").innerText}`, 105, 125, { align: "center" });
    doc.text("Awarded on: " + new Date().toLocaleDateString(), 105, 140, { align: "center" });
    
    // Signature Line
    doc.line(30, 200, 80, 200);
    doc.text("Signature", 55, 210, { align: "center" });
    doc.line(130, 200, 180, 200);
    doc.text("Authority", 155, 210, { align: "center" });
    
    // Footer
    doc.setFontSize(10);
    doc.text("Online Exam System - Certified Excellence", 105, 270, { align: "center" });
    
    doc.save("Certificate.pdf");
}
</script>

</body>
</html>
