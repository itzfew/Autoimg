<!DOCTYPE html>
<html>
<head>
  <title>Exam System</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f5f5f5; }
    header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    .profile { width: 40px; height: 40px; border-radius: 50%; background: #4CAF50; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
    nav a { margin: 0 10px; cursor: pointer; text-decoration: none; color: #333; font-weight: bold; }
    nav a:hover { color: #4CAF50; }
    .container { padding: 20px; }
    .box { background: white; padding: 20px; border-radius: 8px; width: 300px; margin: 50px auto; }
    input, button { width: 100%; padding: 8px; margin: 5px 0; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }

    /* Progress Modal */
    #progressModal {
      display: none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex; justify-content: center; align-items: center;
    }
    .progressBox {
      background: white; padding: 20px; border-radius: 8px; text-align: center; width: 300px;
    }
    .progressBar {
      width: 100%; background: #ddd; height: 20px; border-radius: 10px; overflow: hidden;
    }
    .progressFill {
      height: 100%; width: 0; background: #4CAF50; transition: width 0.2s;
    }
  </style>
</head>
<body>

<header id="topBar" style="display:none;">
  <h2>Exam System</h2>
  <nav id="navLinks"></nav>
  <div class="profile" id="profilePic"></div>
</header>

<div class="container" id="mainContent">
  <!-- Login/Signup Forms -->
  <div class="box" id="authBox">
    <h2 id="formTitle">Login</h2>
    <div id="loginForm">
      <input type="text" id="username" placeholder="Username" required>
      <input type="text" id="rollNumber" placeholder="Roll Number" required>
      <button onclick="login()">Login</button>
    </div>
    <div id="signupForm" style="display:none;">
      <input type="text" id="name" placeholder="Full Name" required>
      <input type="text" id="newUsername" placeholder="Username" required>
      <input type="date" id="dob" required>
      <button onclick="signup()">Create Account</button>
    </div>
    <p id="toggleForm" style="cursor:pointer;color:blue;" onclick="toggle()">Create new account</p>
  </div>

  <!-- Home View -->
  <div id="homeView" style="display:none;">
    <h3>Welcome <span id="userName"></span>!</h3>
    <div id="examSection"></div>
  </div>
</div>

<!-- Progress Modal -->
<div id="progressModal">
  <div class="progressBox">
    <h3>Generating PDF...</h3>
    <div class="progressBar">
      <div class="progressFill" id="progressFill"></div>
    </div>
    <p id="progressText">0%</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx-HPTKFkmhd2gJXgd9JFTjcgamCumgLbOseFp0ZLR7EFC-65v7oSIybsEZYnYvnFXHww/exec";
const { jsPDF } = window.jspdf;

// Toggle Login / Signup
function toggle(){
  let loginForm = document.getElementById("loginForm");
  let signupForm = document.getElementById("signupForm");
  let title = document.getElementById("formTitle");
  if(loginForm.style.display === "none"){
    loginForm.style.display = "block";
    signupForm.style.display = "none";
    title.innerText = "Login";
    document.getElementById("toggleForm").innerText = "Create new account";
  } else {
    loginForm.style.display = "none";
    signupForm.style.display = "block";
    title.innerText = "Signup";
    document.getElementById("toggleForm").innerText = "Already have an account? Login";
  }
}

// Login
function login(){
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "login", username: document.getElementById("username").value, rollNumber: document.getElementById("rollNumber").value })
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      localStorage.setItem("user", JSON.stringify({ ...res, rollNumber: document.getElementById("rollNumber").value }));
      renderHome();
    } else alert("Invalid credentials");
  });
}

// Signup
function signup(){
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "signup", name: document.getElementById("name").value, username: document.getElementById("newUsername").value, dob: document.getElementById("dob").value })
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      alert("Account created! Your Roll No: " + res.rollNumber);
      toggle();
    }
  });
}

// Logout
function logout(){
  localStorage.removeItem("user");
  location.reload();
}

// Show progress
function showProgress(){
  document.getElementById("progressModal").style.display = "flex";
  document.getElementById("progressFill").style.width = "0%";
  document.getElementById("progressText").innerText = "0%";
  let progress = 0;
  let interval = setInterval(()=>{
    if(progress < 95){
      progress += 5;
      document.getElementById("progressFill").style.width = progress + "%";
      document.getElementById("progressText").innerText = progress + "%";
    } else {
      clearInterval(interval);
    }
  }, 100);
}
function hideProgress(){
  document.getElementById("progressFill").style.width = "100%";
  document.getElementById("progressText").innerText = "100%";
  setTimeout(()=> document.getElementById("progressModal").style.display = "none", 400);
}

// PDF: All Results
function downloadAllResults(){
  showProgress();
  fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getAllResults" }) })
    .then(r=>r.json()).then(data=>{
      const doc = new jsPDF();
      doc.text("All Exam Results", 10, 10);
      let y = 20;
      data.forEach(row=>{
        doc.text(`${row.name} (${row.rollNumber}): ${row.marks}/${row.totalMarks}`, 10, y);
        y += 8;
      });
      hideProgress();
      doc.save("All_Results.pdf");
    });
}

// PDF: My Detailed Results
function downloadMyResults(){
  showProgress();
  const user = JSON.parse(localStorage.getItem("user"));
  fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getMyResults", rollNumber: user.rollNumber }) })
    .then(r=>r.json()).then(data=>{
      const doc = new jsPDF();
      doc.text(`${user.name}'s Detailed Results`, 10, 10);
      let y = 20;
      data.forEach((q, i)=>{
        doc.text(`${i+1}. ${q.question}`, 10, y); y += 6;
        doc.text(`Your Answer: ${q.answer}`, 12, y); y += 6;
        doc.text(`Correct Answer: ${q.correctAnswer}`, 12, y); y += 8;
      });
      hideProgress();
      doc.save("My_Detailed_Results.pdf");
    });
}

// PDF: Certificate
function downloadCertificate(){
  showProgress();
  const user = JSON.parse(localStorage.getItem("user"));
  fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getUserScore", rollNumber: user.rollNumber }) })
    .then(r=>r.json()).then(res=>{
      const doc = new jsPDF({ orientation: "landscape" });
      doc.setFontSize(30);
      doc.text("Certificate of Achievement", 50, 50);
      doc.setFontSize(18);
      doc.text(`This is proudly presented to`, 50, 70);
      doc.setFontSize(24);
      doc.text(user.name, 50, 90);
      doc.setFontSize(16);
      doc.text(`For successfully completing the exam with a score of ${res.marks}/${res.totalMarks}`, 50, 110);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 50, 130);
      hideProgress();
      doc.save("Certificate.pdf");
    });
}

// Render Home
function renderHome(){
  const user = JSON.parse(localStorage.getItem("user"));
  if(!user) return;
  document.getElementById("authBox").style.display = "none";
  document.getElementById("homeView").style.display = "block";
  document.getElementById("topBar").style.display = "flex";
  document.getElementById("userName").innerText = user.name;
  document.getElementById("profilePic").innerText = user.name.charAt(0).toUpperCase();

  fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "checkAttempt", rollNumber: user.rollNumber }) })
    .then(r=>r.json()).then(res=>{
      let nav = document.getElementById("navLinks");
      if(res.attempted){
        nav.innerHTML = `
          <a onclick="downloadAllResults()">Results</a>
          <a onclick="downloadMyResults()">My Results</a>
          <a onclick="downloadCertificate()">Certificate</a>
          <a onclick="logout()">Sign Out</a>
        `;
        document.getElementById("examSection").innerHTML = `<p>You have already attempted the exam.</p>`;
      } else {
        nav.innerHTML = `
          <a onclick="downloadAllResults()">Results</a>
          <a onclick="window.location.href='exam.html'">Attempt Test</a>
          <a onclick="logout()">Sign Out</a>
        `;
        document.getElementById("examSection").innerHTML = `<button onclick="location.href='exam.html'">Attempt Exam</button>`;
      }
    });
}

window.onload = function(){
  const user = JSON.parse(localStorage.getItem("user"));
  if(user){ renderHome(); }
};
</script>
</body>
</html>
