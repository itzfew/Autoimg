<!DOCTYPE html>
<html>
<head>
  <title>Exam</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    .question { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; }
    .missed { background: #ffe0e0; }
    button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; margin-top: 10px; }
    button:hover { background: #45a049; }
    #progressModal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); justify-content:center; align-items:center; }
    .progressBox { background:white; padding:20px; border-radius:8px; text-align:center; width:300px; }
    .progressBar { width:100%; background:#ddd; height:20px; border-radius:10px; overflow:hidden; }
    .progressFill { height:100%; width:0; background:#4CAF50; transition: width 0.2s; }
    .nav { margin-top: 20px; }
    .nav a { margin-right: 15px; cursor: pointer; color: #333; font-weight:bold; text-decoration:none; }
    .nav a:hover { color: #4CAF50; }
  </style>
</head>
<body>
<div id="progressModal">
  <div class="progressBox">
    <h3>Processing...</h3>
    <div class="progressBar"><div id="progressFill" class="progressFill"></div></div>
    <p id="progressText">0%</p>
  </div>
</div>

<h1 id="title">Exam</h1>
<div id="content"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx-HPTKFkmhd2gJXgd9JFTjcgamCumgLbOseFp0ZLR7EFC-65v7oSIybsEZYnYvnFXHww/exec";
const { jsPDF } = window.jspdf;

function showProgress() {
  document.getElementById("progressModal").style.display = "flex";
  let progress = 0;
  document.getElementById("progressFill").style.width = "0%";
  document.getElementById("progressText").innerText = "0%";
  window.prog = setInterval(()=>{
    if (progress < 95) {
      progress += 5;
      document.getElementById("progressFill").style.width = progress + "%";
      document.getElementById("progressText").innerText = progress + "%";
    } else clearInterval(prog);
  }, 100);
}

function hideProgress() {
  clearInterval(window.prog);
  document.getElementById("progressFill").style.width = "100%";
  document.getElementById("progressText").innerText = "100%";
  setTimeout(() => document.getElementById("progressModal").style.display = "none", 300);
}

function scrollToQ(i){
  document.getElementById(`q${i}`).scrollIntoView({ behavior: "smooth" });
}

function renderExam(questions) {
  const c = document.getElementById("content");
  c.innerHTML = "";
  questions.forEach((ques, idx) => {
    const div = document.createElement("div");
    div.id = `q${idx}`;
    div.className = "question";
    div.innerHTML = `<p>${idx+1}. ${ques.q}</p>` +
      ques.options.map(opt => `<label><input type="radio" name="q${idx}" value="${opt}"> ${opt}</label>`).join("<br>");
    c.appendChild(div);
  });
  const btn = document.createElement("button");
  btn.textContent = "Submit Exam";
  btn.onclick = () => confirmSubmit(questions);
  c.appendChild(btn);
}

function confirmSubmit(questions) {
  const missed = [];
  questions.forEach((ques, i) => {
    const sel = document.querySelector(`input[name=q${i}]:checked`);
    if (!sel || sel.value.trim()==="") missed.push(i);
  });
  let msg = "Are you sure to submit? It is not reversible.";
  if (missed.length > 0) {
    msg += "\n\nYou missed questions: " + missed.map(i => `<a onclick="scrollToQ(${i})">#${i+1}</a>`).join(", ");
  }
  if (confirm(msg.replace(/<\/?a>/g,""))) submitExam(questions);
}

function submitExam(questions) {
  showProgress();
  const user = JSON.parse(localStorage.getItem("user"));
  let score = 0, details = [];
  questions.forEach((q, i) => {
    const ans = document.querySelector(`input[name=q${i}]:checked`)?.value || "";
    const correct = q.correct;
    const isCorrect = ans === correct;
    if (isCorrect) score++;
    details.push({ question: q.q, answer: ans, correctAnswer: correct, isCorrect });
  });
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "saveResult", quizId: "Exam1",
      rollNumber: user.rollNumber, name: user.name,
      username: user.username,
      marks: score, totalMarks: questions.length, details
    })
  }).then(r=>r.json()).then(res => {
    hideProgress();
    alert(`Submitted! You scored ${score}/${questions.length}`);
    loadPage();
  });
}

function downloadPDF(detailed, title, filename) {
  showProgress();
  const doc = new jsPDF();
  doc.text(title, 10, 10);
  let y = 20;
  detailed.forEach((q,i) => {
    doc.text(`${i+1}. ${q.question}`, 10, y); y += 6;
    doc.text(`Your: ${q.answer}`, 12, y); y += 6;
    doc.text(`Correct: ${q.correctAnswer}`, 12, y); y += 8;
  });
  hideProgress();
  doc.save(filename);
}

function loadPage() {
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) return window.location.href = "index.html";
  showProgress();
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "checkAttempt", rollNumber: user.rollNumber })
  }).then(r=>r.json()).then(res => {
    hideProgress();
    if (res.attempted) {
      // fetch details
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getMyResults", rollNumber: user.rollNumber })
      }).then(r=>r.json()).then(data => {
        const c = document.getElementById("content");
        c.innerHTML = `<h2>Your Detailed Results</h2>`;
        data.forEach((q,i) => {
          c.innerHTML += `<div class="question">
            <p>${i+1}. ${q.question}</p>
            <p>Your: ${q.answer}</p>
            <p>Correct: ${q.correctAnswer}</p>
          </div>`;
        });
        // add PDF and Certificate buttons
        const nav = document.createElement("div"); nav.className="nav";
        nav.innerHTML = `
          <a onclick="downloadPDF(${JSON.stringify(data)}, 'Your Detailed Results', 'My_Result.pdf')">Download PDF</a>
          <a onclick="downloadCertificate()">Download Certificate</a>
        `;
        c.appendChild(nav);
      });
    } else {
      // show exam
      const sampleQs = [
        { q:"2+2=?", options:["3","4","5"], correct:"4" },
        { q:"Capital of France?", options:["Paris","Rome","Berlin"], correct:"Paris" },
        { q:"5 - 2 = ?", options:["2","3","4"], correct:"3" }
      ];
      renderExam(sampleQs);
    }
  });
}

function downloadCertificate(){
  const user = JSON.parse(localStorage.getItem("user"));
  showProgress();
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getUserScore", rollNumber: user.rollNumber })
  }).then(r=>r.json()).then(res => {
    const doc = new jsPDF({ orientation: 'landscape' });
    doc.setFontSize(30); doc.text("Certificate of Achievement", 50, 50);
    doc.setFontSize(24); doc.text(user.name, 50, 90);
    doc.setFontSize(16);
    doc.text(`Score: ${res.marks}/${res.totalMarks}`, 50, 110);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 50, 130);
    hideProgress();
    doc.save("Certificate.pdf");
  });
}

window.onload = loadPage;
</script>
</body>
</html>
